# 2017 January 27
# https://github.com/bevry/base


# Use the latest travis infrastructure
sudo: false


# Complete Node.js Version Matrix
# https://github.com/balupton/awesome-travis#complete-nodejs-version-matrix
language: node_js
node_js:
  - "0.8"   # end of life
  - "0.10"  # end of life
  - "0.12"  # maintenance
  - "4"     # lts
  - "6"     # lts
  - "7"     # stable
matrix:
  fast_finish: true
  allow_failures:
    - node_js: "0.8"
    - node_js: "0.10"
cache:
  directories:
    - node_modules


install: |
  # Ensure NPM is latest
  # https://github.com/balupton/awesome-travis#ensure-npm-is-latest
  export CURRENT_NPM_VERSION="$(npm --version)"
  export LATEST_NPM_VERSION="$(npm view npm version)"
  if test "$CURRENT_NPM_VERSION" != "$LATEST_NPM_VERSION"; then
    echo "running an old npm version, upgrading npm..."
    npm install npm --global --cache-min=Infinity
    echo "...npm upgrade complete"
  fi

  # Ensure dependencies install with a LTS node version
  # https://github.com/balupton/awesome-travis#use-lts-node-version-for-preparation
  export CURRENT_NODE_VERSION="$(node --version)"
  export LTS_NODE_VERSIONS="$(nvm ls-remote --lts)"
  if echo "$LTS_NODE_VERSIONS" | grep "$CURRENT_NODE_VERSION"; then
    echo "running on a LTS node version, completing setup..."
    npm run our:setup
    echo "...setup complete with current LTS version"
  else
    echo "running on a non-LTS node version, completing setup on a LTS node version..."
    nvm install --lts
    export LTS_NODE_INSTALLED_VERSION="$(node --version)"
    npm run our:setup
    nvm use "$TRAVIS_NODE_VERSION"
    echo "...setup complete with LTS"
  fi


before_script: |
  # Ensure compilation and linting occur on a LTS node version
  # https://github.com/balupton/awesome-travis#use-lts-node-version-for-preparation
  if test "$LTS_NODE_INSTALLED_VERSION"; then
    echo "running on a non-LTS node version, compiling with LTS, skipping linting..."
    nvm use "$LTS_NODE_INSTALLED_VERSION"
    npm run our:compile
    nvm use "$TRAVIS_NODE_VERSION"
    echo "...compiled"
  else
    echo "running on a LTS node version, compiling and linting..."
    npm run our:compile && npm run our:verify
    echo "...compiled and linted"
  fi


after_success: |
  # Release to NPM
  # https://github.com/balupton/awesome-travis#release-to-npm
  # travis encrypt "NPM_USERNAME=$NPM_USERNAME" --add env.global
  # travis encrypt "NPM_PASSWORD=$NPM_PASSWORD" --add env.global
  # travis encrypt "NPM_EMAIL=$NPM_EMAIL" --add env.global
  export CURRENT_NODE_VERSION="$(node --version)"
  export LTS_NODE_LATEST_VERSION="$(nvm version-remote --lts)"
  if test "$CURRENT_NODE_VERSION" = "$LTS_NODE_LATEST_VERSION"; then
    if test "$TRAVIS_TAG"; then
      echo "logging in..."
      echo -e "$NPM_USERNAME\n$NPM_PASSWORD\n$NPM_EMAIL" | npm login
      echo "publishing..."
      npm run our:meta
      npm publish
      echo "...released to npm"
    else
      echo "non-tag, no need for release"
    fi
  else
    echo "running on non-latest LTS node version, skipping release to npm"
  fi


# Custom Configuration
env:
  global:
  # Release to NPM
  - secure: AijBP9IaNYvnavo62fyKrAc2uni+JoYAO0y5jsRfc1RsQLENdbA7L2WctIG9P57ndcI2cG5jl4FLp6MhJItIrMH4t/ludYT90/P2MugjfxMp+M19twP2H5gxsw9lI6Qjr16Zke9AeQu1AvLbU12Uy3rNICXzxyyRf2hS7MwSgig=
  - secure: Jh3DZKWtFMWtQZ9je5yZxCNYsS3DHRmuOehTNA3NFXMyGFHCUpYRaVapHcZBZKsWf6AIuNgxdAN9sqfXRg76uuQdNJ/1OMHH4+W2U5CFOO97UnHnte6sJNJCYGJ1U9/E1c3wK+YfAWOqgB/Lfp4wh+1Q0yU4KO8rp1bh1QM/0qs=
  - secure: cXPGNdpEV2G+bRPxkCwwQKS9yjQIqMOBh2YXb0XPdXPDwCfGA79m0+pljSM8WbQ4w3VCgXq9t8a8Bo89V+8HEGvIFpirYnvrnhJLurJ0bthd1uuLCtakfABeb2/JFAuF2Kmt8mtXvDX5MTd78DyTy2beNeEV1Cv38ph6Cbr/u/c=


# https://github.com/balupton/awesome-travis#slack
# https://github.com/balupton/awesome-travis#email
# travis encrypt --org "$SLACK_SUBDOMAIN:$SLACK_TRAVIS_TOKEN#updates" --add notifications.slack
# travis encrypt --org "$TRAVIS_NOTIFICATION_EMAIL" --add notifications.email.recipients
notifications:
  slack:
    secure: iUzG5km154azMO9sWijniOKmc50pvUWzQZA/0FyDEIzvW2a7aoSArj05xkqP7zV4x29GuuAmW0omu0GYT8InwVe3qsVbhg4l2NZUgi0qVMw39YSVNza8JMI0AmNnrddz1HT2u4mDs1UjWKCpdEFhmr03jU6nFNocmRdtLxQM0ek=
  email:
    recipients:
      secure: QOhBO/Xly1iNf8F+EJqyHe97SXjPfhi6U8rvTsFrrZXf25uiCOD8h1PHn8qNj023z1vwyp2qyH2PeQJ6h18C/yKrKWKHBObzfIorjDQjl2k1KZfj4r6egq7exSxcy9g1kg0RIJDEtdAfeM9TMu10SpME2S+g1XwL+FvNe1on9QE=
